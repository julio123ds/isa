<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Procesador CSV / Excel</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-light: linear-gradient(to right, #fff3e0, #e8f5e9);
  --panel-light: #ffffff;
  --text-light: #2b2b2b;
  --accent1-light: #d84315;
  --accent2-light: #2e7d32;
  --border-light: #ddd;
  --highlight-light: #ffcc00;

  --bg-dark: radial-gradient(circle at 30% 30%, #0b1824, #0d1117);
  --panel-dark: #161b22;
  --text-dark: #e6edf3;
  --accent1-dark: #ff9f43;
  --accent2-dark: #5cd6a4;
  --border-dark: #2c3138;
  --highlight-dark: #00bcd4;
}

body {
  font-family: "Inter", system-ui, sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  transition: background .6s ease, color .6s ease;
  display: flex;
  justify-content: center;
}

body.dark {
  background: var(--bg-dark);
  color: var(--text-dark);
}

#darkToggle {
  position: fixed;
  top: 15px;
  right: 20px;
  background: none;
  border: none;
  cursor: pointer;
  width: 50px;
  height: 50px;
  z-index: 999;
}

.sun, .moon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.sun {
  background: radial-gradient(circle, #fff176, #fbc02d);
  animation: spin 8s linear infinite;
}

.moon {
  background: radial-gradient(circle, #d1d8e0, #95a5a6);
  animation: spin 10s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.container {
  width: 100%;
  max-width: 1200px;
  padding: 2rem;
  animation: fadeIn .8s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.panel {
  background: var(--panel-light);
  border-radius: 18px;
  padding: 2rem;
  box-shadow: 0 10px 25px rgba(0,0,0,.1);
  border: 1px solid var(--border-light);
  transition: .4s;
}

body.dark .panel {
  background: var(--panel-dark);
  border-color: var(--border-dark);
}

h1 {
  text-align: center;
  margin-bottom: 1.5rem;
  font-size: 2.3rem;
}

input[type=file] { display: none; }

.upload {
  border: 2px dashed var(--accent1-light);
  padding: 2rem;
  border-radius: 14px;
  text-align: center;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 1rem;
  transition: .3s;
}

body.dark .upload {
  border-color: var(--accent1-dark);
}

button {
  background: var(--accent1-light);
  color: #fff;
  border: none;
  padding: 1rem;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1rem;
  transition: .3s;
  width: 100%;
}

body.dark button {
  background: var(--accent1-dark);
}

button:hover {
  transform: scale(1.03);
  opacity: .95;
}

.preview {
  max-height: 300px;
  overflow: auto;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  margin-top: 1rem;
}

body.dark .preview {
  border-color: var(--border-dark);
}

table {
  border-collapse: collapse;
  width: 100%;
}

th, td {
  border: 1px solid var(--border-light);
  padding: 6px;
  font-size: 13px;
}

body.dark th, body.dark td {
  border-color: var(--border-dark);
}

th {
  background: #fff8f2;
  position: sticky;
  top: 0;
}

body.dark th {
  background: #1b2026;
}

.removed {
  background: #ffcccc;
  text-decoration: line-through;
  opacity: .6;
}

.duplicate {
  background: var(--highlight-light);
}

body.dark .duplicate {
  background: var(--highlight-dark);
  color: #fff;
}

.log {
  margin-top: 1rem;
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow-y: auto;
  font-family: ui-monospace, monospace;
  font-size: 13px;
  border-radius: 8px;
}
</style>
</head>

<body>
<button id="darkToggle"><div class="sun"></div></button>

<div class="container">
  <h1>Procesador de Excel / CSV</h1>

  <div class="panel">
    <label class="upload">
      Clic para subir CSV o XLSX
      <input type="file" id="fileInput" accept=".csv,.xlsx">
    </label>

    <button onclick="procesar()">Procesar y descargar CSV</button>

    <div class="preview" id="preview"></div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const toggle = document.getElementById("darkToggle");
let isDark = false;

toggle.onclick = () => {
  isDark = !isDark;
  document.body.classList.toggle("dark", isDark);
  toggle.innerHTML = isDark ? '<div class="moon"></div>' : '<div class="sun"></div>';
};

let rows = [];
const logBox = document.getElementById("log");
const preview = document.getElementById("preview");

function log(txt) {
  logBox.innerHTML += txt + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  log("Archivo cargado: " + file.name);
  const reader = new FileReader();

  if (file.name.endsWith(".xlsx")) {
    reader.readAsArrayBuffer(file);
    reader.onload = ev => {
      const wb = XLSX.read(ev.target.result, { type: "array" });
      rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
      render();
    };
  } else {
    reader.readAsText(file, "utf-8");
    reader.onload = ev => {
      const wb = XLSX.read(ev.target.result.replace(/^\uFEFF/, ""), { type: "string" });
      rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
      render();
    };
  }
});

function render(highlight = {}) {
  if (!rows.length) return;
  let html = "<table><thead><tr><th>#</th>";
  rows[0].forEach((_, i) => html += `<th>${String.fromCharCode(65+i)}</th>`);
  html += "</tr></thead><tbody>";

  rows.forEach((r, i) => {
    html += `<tr class="${highlight.row === i ? 'removed':''}"><td>${i+1}</td>`;
    r.forEach((c, j) => {
      let cls = "";
      if (highlight.col === j) cls = "removed";
      if (highlight.dup === i) cls = "duplicate";
      html += `<td class="${cls}">${c ?? ""}</td>`;
    });
    html += "</tr>";
  });

  preview.innerHTML = html + "</tbody></table>";
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

async function procesar() {
  if (!rows.length) return alert("Carga un archivo primero");

  log("Eliminando fila 1...");
  render({ row: 0 });
  await sleep(600);
  rows.shift(); render();

  log("Eliminando columna B...");
  rows.forEach(r => r.splice(1,1));
  render({ col: 1 });
  await sleep(600); render();

  log("Eliminando columnas K a O...");
  rows.forEach(r => r.splice(9,5));
  render(); await sleep(600);

  log("Procesando SKU duplicados...");
  let map = {};
  for (let i=1;i<rows.length;i++) {
    let sku = rows[i][0];
    if (!sku) continue;
    if (!map[sku]) map[sku] = 0;
    else {
      map[sku]++;
      rows[i][0] = sku + String.fromCharCode(96 + map[sku]);
      render({ dup: i });
      await sleep(300);
    }
  }

  log("Generando CSV UTF-8...");
  descargarCSV();
}

function descargarCSV() {
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const csv = XLSX.utils.sheet_to_csv(ws);
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "resultado.csv";
  a.click();
  log("Archivo descargado correctamente.");
}
</script>
</body>
</html>
